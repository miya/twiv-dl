<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>twiv-dl</title>
    <meta name="author" content="miya">
    <meta name="description" content="Twitterの動画をダウンロードできるWebサービスです">
    <meta property="og:locale" content="ja_JP">
    <meta property="og:type" content="website">
    <meta property="og:title" content="twiv-dl">
    <meta property="og:description" content=Twitterの動画をダウンロードできるWebサービスです">
    <meta property="og:url" content="http://twivdl.appspot.com/">
    <meta property="og:site_name" content="twiv-dl">
    <meta property="og:image" content="https://user-images.githubusercontent.com/34241526/83238289-335a1580-a1d1-11ea-841e-9464f1552344.png">
    <meta property="og:image:secure_url" content="https://user-images.githubusercontent.com/34241526/83238289-335a1580-a1d1-11ea-841e-9464f1552344.png">
    <meta property="og:image:width" content="512">
    <meta property="og:image:height" content="512">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="twiv-dl">
    <meta name="twitter:description" content="Twitterの動画をダウンロードできるWebサービスです">
    <meta name="twitter:image" content="https://user-images.githubusercontent.com/34241526/83238289-335a1580-a1d1-11ea-841e-9464f1552344.png">
    <link rel="apple-touch-icon" href="https://user-images.githubusercontent.com/34241526/83238289-335a1580-a1d1-11ea-841e-9464f1552344.png"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" rel="stylesheet">
</head>
<body>
    <div class="container text-center align-items-center mt-5 mb-5">
        
        <!--タイトル-->
        <h1 class="mb-3">twiv-dl</h1>
        
        <!--説明-->
        <p class="text-muted">Twitterの動画をダウンロードできるWebサービス<br>下記のフォームに動画付きツイートのURLを入力してください<br class="pb-5">© 2020 <a href="https://keybase.io/p_q">miya</a> 😎 source code is <a href="https://github.com/miya/twiv-dl">here</a></p>
        
        <div class="input-group mb-3">
            <!--URL入力フォーム-->
            <input id="inputForm" type="text" class="form-control " placeholder="https://twitter.com/i/status/xxxxxxxxxxxxxxxx" aria-label="">
            <!--ボタン-->
            <div class="input-group-append">
                <button type="button" id="searchBtn" class="btn btn-primary"><i class="fas fa-search"></i></button>
            </div>
        </div>
        
        <!--アラート-->
        <div id="alert" style="display: none;"></div>
        
        <!--動画埋め込み-->
        <div id="video" style="display: none"></div>
        
        <!--ダウンロードボタン-->
        <div id=dlBtns class="mt-3" style="display: none;"></div>
    </div>
</body>
<script>
    
    const submitBtn = document.getElementById("searchBtn");
    submitBtn.onclick = () => {
        const inputUrl = document.getElementById("inputForm");
        if (inputUrl.value==="") {
            alert(false, "URLを入力してください。");
        } else {
            postData(inputUrl.value);
        }
        inputUrl.value = "";
    };
    
    const alert = (status, message) => {
        const alertEle = document.getElementById("alert");
        const successIcon = "<strong><i class=\"fas fa-check\"></i></strong>";
        const failureIcon = "<strong><i class=\"fas fa-exclamation-circle\"></i></strong>";
        const alertHtml = `<div class="alert alert-${(status)? "success":"danger"}" role="alert">${(status)? successIcon:failureIcon} ${message}</div>`;
        alertEle.style.display = "block";
        alertEle.innerHTML = alertHtml;
    };
    
    const video = (videoData) => {
        let videoUrl = ""
        const videoEle = document.getElementById("video");
        if ("large" in videoData) {
            videoUrl = videoData["large"]["url"]
        } else if ("medium" in videoData) {
            videoUrl = videoData["medium"]["url"]
        } else if ("small" in videoData) {
            videoUrl = videoData["small"]["url"]
        }
        const videoHtml = `<div class="embed-responsive embed-responsive-16by9"><iframe class="embed-responsive-item" src="${videoUrl}" allowfullscreen></iframe></div>`;
        videoEle.style.display = "block";
        videoEle.innerHTML = videoHtml;
    };
    
    const dlBtns = (videoData) => {
        let inputHtml = "<p class=\"text-muted\">ダウンロード</p>";
        if ("small" in videoData) {
            inputHtml += `<a href="download/${videoData["small"]["url"]}" class="pr-2">${videoData["small"]["size"]}</a>`
        }
        if ("medium" in videoData) {
            inputHtml += `<a href="download/${videoData["medium"]["url"]}" class="pr-2">${videoData["medium"]["size"]}</a>`
        }
        if ("large" in videoData) {
            inputHtml += `<a href="download/${videoData["large"]["url"]}" class="pr-2">${videoData["large"]["size"]}</a>`
        }
        const dlBtnsEle = document.getElementById("dlBtns");
        dlBtnsEle.style.display = "block";
        dlBtnsEle.innerHTML = inputHtml;
    };
    
    const postData = (url) => {
        return fetch("/search", {
            method: "POST",
            body : JSON.stringify({inputUrl: url}),
            headers: {"Content-Type": "application/json"}
        })
            .then(response => response.json())
            .then(data => {
                const status = data["status"];
                const message = data["message"];
                alert(status, message);
                if (status) {
                    const videoData = data["data"];
                    video(videoData);
                    dlBtns(videoData);
                }
            })
            .catch(error => {
                console.log("error: ", error);
                alert(false, "サーバーとの通信に失敗しました");
            });
    };
</script>
</html>